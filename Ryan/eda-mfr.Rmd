---
title: "Multi-family Residential Analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
df <- read.csv("/Users/ryankobler/Desktop/thesis/Thesis/DATA/thesis-data.csv")

# Testing automatically setting the pathname)
# current_path <- rstudioapi::getActiveDocumentContext()$path 
# folders <- unlist(str_split(current_path, "/"))
# print(folders)
# i <- which("Thesis" == folders)
# print(i)
# short_fold <- folders[1:i]
# print(short_fold)
# new_path <- paste(short_fold, collapse = "/")
# setwd(dirname(new_path))
###########

# TIDY
df %<>%
  rename(nbhd = NAME) %>%
  mutate(n_fireplaces = ifelse(is.na(n_fireplaces), 0, n_fireplaces))


# DROPS
df %<>%
  mutate(saledate = as.Date(saledate),
         lnprice = log(SALEPRICE),
         
         # define flags
         proud_flag =  grepl("PROUD", OWNER1) | 
           grepl("PROUD", OWNER2) | grepl("PROUD", OWNER3),
         trust_flag = grepl("TRUST", OWNER1) | 
           grepl("TRUST", OWNER2) | grepl("TRUST", OWNER3), 
         top_1 =  SALEPRICE > quantile(SALEPRICE, .99),
         price_diff = SALEPRICE - LANDVAL3, 
         price_ratio = SALEPRICE/LANDVAL3 * 100,
         vacant_dummy = PRPCD_DESC == "VACANT LAND") %>%
  mutate(arms_length = price_ratio > 20)

constraints <- c("conWetland", "conNatAm", 
                   "conAirHgt", "conCovrly", "conPovrly", "conHeliprt",
                   "conHist", "conHistLdm", "conInstit", 
                 "conLSHA", "conLUST",
                   "conNoise", "conPrvCom", "conSewer", "conSLIDO",
                   "conSlp25", "conStorm", "conTranCap", "conTranSub",
                   "conTranInt", "conTranSub", "conView", "conWater", 
                 "conGW", "conPubOwn", "conFldway", "conFld100", "conECSI")


# switch the NAs in the constraints to 0s
to0 <- function(x){ifelse(is.na(x), 0, x)}

trim <- df %>% 
  filter(proud_flag == F, top_1 == F,
           arms_length == T, vacant_dummy == F) %>%
  mutate_at(vars(constraints), to0) %>%
  mutate(YEARBUILT = as.numeric(YEARBUILT)) %>%
  mutate(YEARBUILT = case_when(
    YEARBUILT < 1000 ~ NA_real_,
    YEARBUILT > 2019 ~ NA_real_,
    TRUE ~ YEARBUILT))

constraint_sums <- trim %>%
  select(constraints) %>%
  rowSums()

trim %<>%
  mutate(is_constrained = constraint_sums > 0)

gar_sqft_sum <- trim %>%
  select(matches("gar")) %>%
  rowSums()

# attic sqft
attic_sqft_sum <- trim %>%
  select(matches("attic")) %>%
  rowSums()

# basement sqft
bsmt_sqft_sum <- trim %>%
  select(matches("bsmt")) %>%
  select(-c("BSMT.PARKING","BSMT.GAR")) %>%
  rowSums()

trim %<>%
  mutate(garage_sqft = gar_sqft_sum,
         garage_dum = garage_sqft > 0,
         attic_sqft = attic_sqft_sum,
         attic_dum = attic_sqft > 0,
         bsmt_sqft = bsmt_sqft_sum,
         bsmt_dum = bsmt_sqft > 0,
         year_sold = format(saledate, "%Y"))

mfr.dat <- trim %>%
  filter(prop_type == "Multi-family")
```


## Looking for trends 
```{r}
cts_vars <- c("dist_cityhall", "dist_ugb", "UNITS", "h_baths",
"f_baths", "totalsqft", "AREA", "avgheight", "garage_sqft","bsmt_sqft",
"pct_canopy_cov", "YEARBUILT", "CN_score", "attic_sqft", "BLDGSQFT")

plotCts <- function(i, df){
  ggplot(data = df, 
                         aes(y = I(log(SALEPRICE)), 
                             x = get(cts_vars[i]))) +
    geom_jitter(alpha = 0.4) +
    geom_smooth() +
    labs(title = "",
         y = "sale price",
         x = cts_vars[i]) + 
    theme_minimal() %>% list()
}

plot_list <- lapply(1:length(cts_vars), plotCts, df = mfr.dat)
names(plot_list) <- cts_vars
cowplot::plot_grid(plotlist = plot_list[1:4], ncol = 2, nrow = 2)
cowplot::plot_grid(plotlist = plot_list[5:8], ncol = 2, nrow = 2)
cowplot::plot_grid(plotlist = plot_list[9:12], ncol = 2, nrow = 2)
plot_list["BLDGSQFT"]
```


## Detecting outliers

```{r}
# define histogram plotting function
plotHist <- function(string, binthere = 100, dfthat){
  ggplot(data = dfthat, aes(x = get(string))) +
    geom_histogram(binwidth = binthere) +
    labs(title = "",
         x = string) + 
    theme_minimal() %>% list()
}

plot_list <- lapply(cts_vars, plotHist, dfthat = mfr.dat, binthere = 100)
names(plot_list) <- cts_vars
cowplot::plot_grid(plotlist = plot_list[1:4], ncol = 2, nrow = 2)
cowplot::plot_grid(plotlist = plot_list[5:8], ncol = 2, nrow = 2)
cowplot::plot_grid(plotlist = plot_list[9:12], ncol = 2, nrow = 2)

#------------------------------
```


```{r}
mfr.dat %>%
  select(cts_vars) %>%
  summary()

mfr.dat %>%
  filter(BLDGSQFT == 0, is.na(totalsqft)) %>%
  select(f_baths, STATE_ID, SITEADDR, UNITS)
```

We have 297 observations for which BLDGSQFT == 0.

**avgheight** there are some crazy outliers here (> 60), note that there are also 907 data points that are missing for this var. Wish we could get a sense of the level of floors a property has, may be more important for MFR...

**bsmt_sqft** again, some big outliers > 10000 sqft (this may be because they include both finished an unfinished segments at different points in time?)

**totalsqft** bigger than 75,000 seems kind of unreasonable.

**pct_canopy_cov** some heteroskedasticity in this variable, decreasing variance as pct covered increases. Maybe log it?

## Remove outliers

```{R}
mfr.dat %<>%
  filter(bsmt_sqft < 10000 | totalsqft < 75000 | avgheight < 60 | 
           (!is.na(totalsqft) & BLDGSQFT != 0))
```

---
# Robustness

## Test robustness of estimates to different spatial sizes

## K-fold CV 

## Price ratio (pruning out arms-length)
---

## Explore Random Effects

## Explore Hausman Taylor

## Test for spatial lag between our $y$s 
This matters more in terms of bias.



## Mapping spatially correlated errors


